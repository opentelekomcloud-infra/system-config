{% import 'macros.j2' as mcr with context %}
{% include '_annotations.yaml.j2' %}
description: Data for the Network service
editable: false
panels:
{% include '_header.yaml.j2' %}

{% include '_service_header.yaml.j2' %}

  - datasource: {{ grafana_ds | default('apimon') }}
    fill: 1
    {{ mcr.grid_pos(0, 6, 6, 12) }}
    legend:
      show: true
      alignAsTable: true
      rightSide: true
      values: true
      current: true
    lines: true
    linewidth: 1
    nullPointMode: connected
    options:
      alertThreshold: true
    renderer: flot
    spaceLength: 10
    targets:
      - refId: A
        target: groupByNode(stats.timers.apimon.metric.$environment.$zone.csm_lb_timings.public.*.*.mean, 8, 'avg')
    title: LoadBalancer Latency per type
    type: graph
    xaxis:
      mode: time
      show: true
    yaxes:
      - format: ms
        logBase: 1
        show: true
      - show: false

  - datasource: {{ grafana_ds | default('apimon') }}
    fill: 1
    {{ mcr.grid_pos(12, 6, 6, 12) }}
    legend:
      show: true
      alignAsTable: true
      rightSide: true
      values: true
      current: true
    lines: true
    linewidth: 1
    nullPointMode: connected
    options:
      alertThreshold: true
    renderer: flot
    spaceLength: 10
    targets:
      - refId: A
        target: groupByNode(stats.timers.apimon.metric.$environment.$zone.csm_lb_timings.public.*.*.mean, 9, 'avg')
    title: LoadBalancer Latency per AZ
    type: graph
    xaxis:
      mode: time
      show: true
    yaxes:
      - format: ms
        logBase: 1
        show: true
      - show: false

  - datasource: {{ grafana_ds | default('apimon') }}
    description: |
      Curl like request latencies to the hosts in scenario30_domains.yaml
    fill: 1
    {{ mcr.grid_pos(0, 15, 6, 18) }}
    legend:
      show: true
      alignAsTable: true
      rightSide: true
      values: true
      current: true
    lines: true
    linewidth: 1
    nullPointMode: connected
    options:
      alertThreshold: true
    renderer: flot
    spaceLength: 10
    targets:
      - refId: A
        target: aliasByNode(stats.timers.apimon.metric.$environment.$zone.curl.*.{2*,3*}.mean, 5, 7)
    title: Domains curl Latency
    thresholds: 
      - value: 300
        colorMode: "warning"
        op: "gt"
        fill: true
        line: true
        yaxis: "left"
      - value: 500
        colorMode: "critical"
        op: "gt"
        fill: true
        line: true
        yaxis: "left"
    type: graph
    xaxis:
      mode: time
      show: true
    yaxes:
      - format: ms
        min: 0
        show: true
      - show: false

  - datasource: {{ grafana_ds | default('apimon') }}
    description: |
      Curl like request errors (4*, 5*, failed) for the hosts in scenario30_domains.yaml
    fill: 1
    {{ mcr.grid_pos(18, 15, 6, 6) }}
    legend:
      show: true
    lines: false
    points: true
    pointRadius: 1
    nullPointMode: connected
    options:
      alertThreshold: true
    renderer: flot
    spaceLength: 10
    targets:
      - refId: A
        target: aliasByNode(stats.counters.apimon.metric.$environment.$zone.curl.*.{4*,5*}.attempted.count, 7, 8)
      - refId: B
        target: aliasByNode(stats.counters.apimon.metric.$environment.$zone.curl.*.failed.count, 7, 8)
    title: Domains curl Errors
    type: graph
    xaxis:
      mode: time
      show: true
    yaxes:
      - show: false
      - show: false

  - datasource: {{ grafana_ds | default('apimon') }}
    description: |
      NS Lookup from specific NS servers
    fill: 1
    {{ mcr.grid_pos(0, 16, 6, 18) }}
    legend:
      show: true
    lines: true
    nullPointMode: connected
    options:
      alertThreshold: true
    renderer: flot
    spaceLength: 10
    targets:
      - refId: A
        target: groupByNodes(stats.timers.apimon.metric.$environment.$zone.dns.*.*.mean, 'avg', 7, 8)
    title: NS Lookup
    type: graph
    xaxis:
      mode: time
      show: true
    yaxes:
      - show: true
        min: 0
        format: "ms"
        decimals: 0
      - show: false

  - datasource: {{ grafana_ds | default('apimon') }}
    description: |
      NS Lookup failures from specific NS servers
    fill: 1
    {{ mcr.grid_pos(18, 16, 6, 6) }}
    legend:
      show: true
    lines: true
    nullPointMode: connected
    options:
      alertThreshold: true
    renderer: flot
    spaceLength: 10
    targets:
      - refId: A
        target: aliasByNode(stats.counters.apimon.metric.$environment.$zone.dns.*.*.failed.count, 7, 8)
    title: NS Lookup Failures
    type: graph
    xaxis:
      mode: time
      show: true
    yaxes:
      - show: false
      - show: false

  - datasource: {{ grafana_ds | default('apimon') }}
    description: |
      Ping latency for hosts inside VPC or through VPC Peering using internal IP addresses
    fill: 1
    {{ mcr.grid_pos(0, 24, 8, 18) }}
    legend:
      show: true
    lines: true
    nullPointMode: connected
    options:
      alertThreshold: true
    renderer: flot
    spaceLength: 10
    targets:
      - refId: A
        target: groupByNodes(stats.timers.apimon.metric.$environment.$zone.ping.{vpc,peering}.*.*.mean, 'avg', 9)
    title: Internal VPC/Peering Latency
    type: graph
    xaxis:
      mode: time
      show: true
    yaxes:
      - show: true
        min: 0
        format: "ms"
        decimals: 0
      - show: false

  - datasource: {{ grafana_ds | default('apimon') }}
    description: |
      Ping errors for hosts inside VPC/VPC peering using internal IP addresses
    fill: 1
    {{ mcr.grid_pos(18, 24, 8, 6) }}
    legend:
      show: true
    options:
      alertThreshold: true
    points: true
    renderer: flot
    spaceLength: 10
    targets:
      - refId: A
        target: groupByNodes(stats.counters.apimon.metric.$environment.$zone.ping.{peering,vpc}.*.*.failed, 'sum', 7)
    title: Internal ping errors
    type: graph
    xaxis:
      mode: time
      show: true
    yaxes:
      - show: false
      - show: false

  - datasource: {{ grafana_ds | default('apimon') }}
    description: |
      Ping latency for outside world through NATGW and Shared SNAT
    fill: 1
    {{ mcr.grid_pos(0, 32, 8, 18) }}
    legend:
      show: true
    lines: true
    nullPointMode: connected
    options:
      alertThreshold: true
    renderer: flot
    spaceLength: 10
    targets:
      - refId: A
        target: groupByNodes(stats.timers.apimon.metric.$environment.$zone.ping.{natgw,snat}.*.mean, 'avg', 7)
    title: Outside NATGW/SNAT ping Latency
    type: graph
    xaxis:
      mode: time
      show: true
    yaxes:
      - show: true
        min: 0
        format: "ms"
        decimals: 0
      - show: false

  - datasource: {{ grafana_ds | default('apimon') }}
    description: |
      Outside ping errors. Single errors are not an problem indicator (pinging hosts in different countries).
    fill: 1
    {{ mcr.grid_pos(18, 32, 8, 6) }}
    legend:
      show: true
    options:
      alertThreshold: true
    points: true
    renderer: flot
    spaceLength: 10
    targets:
      - refId: A
        target: groupByNodes(stats.counters.apimon.metric.$environment.$zone.ping.{natgw,snat}.*.failed, 'sum', 7)
    title: Outside ping errors
    type: graph
    xaxis:
      mode: time
      show: true
    yaxes:
      - show: false
      - show: false


{{ mcr.service_api_latency('network', 100) }}
{{ mcr.service_bad_calls('network', 101) }}
{{ mcr.service_failures(102) }}
{{ mcr.service_results(103) }}

refresh: false
style: dark
tags:
  - network
  - apimon
templating:
  list:
{% include '_template_env.yaml.j2' %}
{% include '_template_zone.yaml.j2' %}
      multi: true

{{ mcr.service_scenarios_template(['scenario2_simple_ecs.yaml',
'scenario2a_ecs_az.yaml', 'scenario19_simple_vpc.yaml',
'scenario30_domains.yaml', 'scenario31_nslookup.yaml',
'lb_monitoring.yaml']) }}

time:
  from: now-6h
  to: now
timepicker:
  refresh_intervals:
    - 10s
    - 30s
    - 1m
    - 5m
    - 15m
    - 30m
    - 1h
    - 2h
    - 1d
timezone: ''
title: Network Service statistics
uid: APIMonNSS
