# NOTE(gtema): this is ephemeral to the Ansible run; it is updating the
# in-memory inventory.
- hosts: localhost
  tasks:
    - name: Add bridge to inventory
      add_host:
        name: bridge.eco.tsi-dev.otc-service.com
        ansible_python_interpreter: python3
        ansible_user: zuul
        # Without setting ansible_host directly, mirror-workspace-git-repos
        # gets sad because if delegate_to localhost and with add_host that
        # ends up with ansible_host being localhost.
        ansible_host: bridge.eco.tsi-dev.otc-service.com
        ansible_port: 22

- hosts: bridge.eco.tsi-dev.otc-service.com:!disabled
  name: "Bridge: boostrap the bastion host"
  become: true
  roles:
    - pip3
    # Note for production use we expect to take the defaults; unit
    # test jobs override this to test with latest upstream ansible.
    # For example, if there is a fix on the ansible stable branch we
    # need that is unreleased, you could do the following:
    #
    - role: install-ansible
      install_ansible_name: '{{ bridge_ansible_name | default("ansible") }}'
      install_ansible_version: '{{ bridge_ansible_version | default("4.0.0") }}'
      install_ansible_openstacksdk_name: '{{ bridge_openstacksdk_name | default("openstacksdk") }}'
      install_ansible_openstacksdk_version: '{{ bridge_openstacksdk_verison | default("latest") }}'
      install_ansible_collections:
        - namespace: opentelekomcloud
          name: apimon
          repo: opentelekomcloud/ansible-collection-apimon
        - namespace: opentelekomcloud
          name: cloud
          repo: opentelekomcloud/ansible-collection-cloud
        - namespace: opentelekomcloud
          name: gitcontrol
          repo: opentelekomcloud/ansible-collection-gitcontrol
        - namespace: openstack
          name: cloud
          repo: openstack/ansible-collections-openstack
          git_provider: opendev.org
    - root-keys

  tasks:
    - name: Ensure sc2 folders
      ansible.builtin.file:
        path: "{{ item }}"
        state: "directory"
      loop:
        - "/home/zuul/src/gitlab/ecosystem/system-config/inventory/base"
        - "/home/zuul/src/gitlab/ecosystem/system-config/inventory/service"

    - name: Ensure sc2 files
      ansible.builtin.file:
        path: "{{ item }}"
        state: "touch"
      loop:
        - "/home/zuul/src/gitlab/ecosystem/system-config/inventory/base/hosts.yaml"
        - "/home/zuul/src/gitlab/ecosystem/system-config/inventory/service/groups.yaml"
