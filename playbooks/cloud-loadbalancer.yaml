---
- hosts: cloud-launcher:!disabled
  name: "Manage cloud load balancers with enhanced security"
  become: true
  vars_files:
    - "../otc-security/load-balancers/enhanced-lb-config.yaml"
    - "../otc-security/load-balancers/security-policies.yaml"

  tasks:
    - name: Get vault token
      ansible.builtin.set_fact:
       vault_token: "{{ lookup('community.hashi_vault.hashi_vault', 'auth/token/lookup-self') }}"
      when: "ansible_hashi_vault_token is not defined"

    - name: Set vault token
      ansible.builtin.set_fact:
        ansible_hashi_vault_token: "{{ vault_token.id }}"
        ansible_hashi_vault_auth_method: "token"
      when: "vault_token is defined"

    - name: Deploy load balancer certificates
      include_role:
        name: cloud_loadbalancer_cert
      loop: "{{ cloud_load_balancer_certificates | default([]) }}"
      loop_control:
        loop_var: "cert"
      tags: ["lb_certs"]

    - name: Deploy standard load balancers
      include_role:
        name: cloud_loadbalancer
      loop: "{{ cloud_load_balancers | default([]) }}"
      loop_control:
        loop_var: "lb"
      tags: ["standard_lb"]

    - name: Deploy enhanced load balancers
      include_role:
        name: cloud_loadbalancer
      vars:
        lb: "{{ item }}"
        state: "present"
      loop: "{{ [enhanced_elb_swift, enhanced_elb_eco_infra, enhanced_elb_zuul] | select('defined') | list }}"
      tags: ["enhanced_lb"]

    - name: Log load balancer deployment summary
      ansible.builtin.debug:
        msg: |
          Load balancer deployment:
          - Standard LBs: {{ cloud_load_balancers | default([]) | length }}
          - Enhanced LBs: {{ [enhanced_elb_swift, enhanced_elb_eco_infra, enhanced_elb_zuul] | select('defined') | list | length }}
      tags: ["always"]

