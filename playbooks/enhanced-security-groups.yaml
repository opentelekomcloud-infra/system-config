---
- hosts: cloud-launcher:!disabled
  name: "Deploy enhanced security groups with threat intelligence"
  become: true
  vars_files:
    - "../otc-security/security-groups/enhanced-security-groups.yaml"
    - "../otc-security/security-groups/threat-intelligence-sg.yaml"

  tasks:
    - name: Get vault token
      ansible.builtin.set_fact:
        vault_token: "{{ lookup('community.hashi_vault.hashi_vault', 'auth/token/lookup-self') }}"
      when: "ansible_hashi_vault_token is not defined"

    - name: Set vault token
      ansible.builtin.set_fact:
        ansible_hashi_vault_token: "{{ vault_token.id }}"
        ansible_hashi_vault_auth_method: "token"
      when: "vault_token is defined"

    - name: Deploy standard cloud security groups
      include_role:
        name: cloud_sg
      loop: "{{ cloud_security_groups | default([]) }}"
      loop_control:
        loop_var: sg
      tags: ["standard_sg"]

    - name: Deploy enhanced security groups
      include_role:
        name: cloud_sg
      vars:
        sg: "{{ item }}"
        state: "present"
      loop: "{{ enhanced_cloud_security_groups | default([]) }}"
      tags: ["enhanced_sg"]

    - name: Deploy threat intelligence security groups
      include_role:
        name: cloud_sg
      vars:
        sg: "{{ item }}"
        state: "present"
      loop: "{{ threat_intelligence_security_groups | default([]) }}"
      tags: ["threat_intel_sg"]

    - name: Log security groups deployment
      ansible.builtin.debug:
        msg: |
          Security groups deployment completed:
          - Standard groups: {{ cloud_security_groups | default([]) | length }}
          - Enhanced groups: {{ enhanced_cloud_security_groups | default([]) | length }}
          - Threat intel groups: {{ threat_intelligence_security_groups | default([]) | length }}
      tags: ["always"]

    - name: Update threat intelligence feeds
      ansible.builtin.script:
        cmd: "../otc-security/automation/update-threat-intel.sh"
        creates: "/tmp/threat-intel-last-update"
      environment:
        VAULT_ADDR: "{{ ansible_hashi_vault_addr }}"
        VAULT_TOKEN: "{{ ansible_hashi_vault_token }}"
      tags: ["threat_intel_update"]

    - name: Schedule threat intelligence updates
      ansible.builtin.cron:
        name: "Update OTC threat intelligence"
        minute: "0"
        hour: "*"
        job: "{{ ansible_env.PWD }}/../otc-security/automation/update-threat-intel.sh"
        user: root
        state: present
      tags: ["threat_intel_schedule"]
