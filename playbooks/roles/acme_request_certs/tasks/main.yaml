- set_fact:
    acme_txt_required: []
    acme_challenge: {}

- name: Create directory to store certs
  file:
    path: "{{ certs_path }}"
    state: directory

- name: Generate account key
  community.crypto.openssl_privatekey:
    path: "{{ certs_path }}/account-key.pem"
    size: 4096

- name: Create account
  community.crypto.acme_account:
    account_key_src: "{{ certs_path }}/account-key.pem"
    acme_directory: "{{ acme_directory }}"
    acme_version: 2
    state: present
    terms_agreed: yes
    contact: "{{ acme_account_contact | default(omit) }}"

- include_tasks: acme.yaml
  loop: "{{ query('dict', ssl_certs) }}"
  loop_control:
    loop_var: cert
  when: not ssl_cert_selfsign

- include_tasks: selfsign.yaml
  loop: "{{ query('dict', ssl_certs) }}"
  loop_control:
    loop_var: cert
  when: ssl_cert_selfsign

