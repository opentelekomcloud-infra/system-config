---
- name: Set resource naming
  set_fact: 
    grafana_config_name: "grafana-config-{{ instance }}"
    grafana_secret_name: "grafana-secret-{{ instance }}"
    grafana_deployment_name: "grafana-deployment-{{ instance }}"
    grafana_service_name: "grafana-service-{{ instance }}"
    grafana_ingress_name: "grafana-ingress-{{ instance }}"
    grafana_ssl_cert_name: "grafana-ssl-{{ instance }}"
    cluster_version: "{{ lookup('k8s', cluster_info='version') }}"
    k8s_17: False

- name: set k8s version
  set_fact:
    k8s_17: True
  when: cluster_version.kubernetes.minor[:2] == "17"

- name: Create ConfigMap
  community.kubernetes.k8s:
    context: "{{ context }}"
    state: "present"
    namespace: "{{ namespace }}"
    name: "{{ grafana_config_name }}"
    api_version: "v1"
    kind: "ConfigMap"
    definition:
      metadata:
        labels:
          app.kubernetes.io/app: "grafana"
          app.kubernetes.io/instance: "{{ instance }}"
          app.kubernetes.io/managed-by: "system-config"
      data:
        ldap.toml: "{{ lookup('template', 'templates/grafana/ldap.toml.j2') }}"
        ldap-root-ca-cert.crt: "{{ grafana.grafana_auth_ldap_certificate | default(grafana.default.grafana_auth_ldap_certificate) }}"

- name: Create Secrets
  community.kubernetes.k8s:
    context: "{{ context }}"
    state: "present"
    namespace: "{{ namespace }}"
    name: "{{ grafana_secret_name }}"
    api_version: "v1"
    kind: "Secret"
    definition: "{{ lookup('template', 'grafana-secret.yaml.j2') | from_yaml }}"

- name: Start Grafana deployment 
  community.kubernetes.k8s:
    context: "{{ context }}"
    state: "present"
    namespace: "{{ namespace }}"
    name: "{{ grafana_deployment_name }}"
    definition: "{{ lookup('template', 'grafana-deployment.yaml.j2') | from_yaml }}"

- name: Expose Grafana deployment with service
  community.kubernetes.k8s:
    context: "{{ context }}"
    state: "present"
    namespace: "{{ namespace }}"
    name: "{{ grafana_service_name }}"
    definition: "{{ lookup('template', 'grafana-service.yaml.j2') | from_yaml }}"

- name: Start Grafana ingress
  community.kubernetes.k8s:
    context: "{{ context }}"
    state: "present"
    namespace: "{{ namespace }}"
    name: "{{ grafana_ingress_name }}"
    definition: "{{ lookup('template', 'grafana-ingress.yaml.j2') | from_yaml }}"
