---
- name: "Set cloud env"
  set_fact:
    cloud: "{{ hostvars[host].location.cloud }}"

- name: "Set cloud_auth env if applicable "
  set_fact:
    cloud_auth: "{{ clouds[cloud].auth_cloud }}"
  when: "clouds[cloud].auth_cloud is defined"

- name: "Read vault data"
  no_log: true
  community.hashi_vault.vault_read:
    url: "{{ ansible_hashi_vault_addr }}"
    token: "{{ ansible_hashi_vault_token }}"
    path: "{{ clouds[cloud].vault_path }}"
  register: "cloud_token"
  when: "clouds[cloud].vault_path is defined"

- name: "Set cloud_auth variable with auth artifacts from vault"
  no_log: true
  set_fact:
    cloud_auth: "{{ cloud_token.data.data }}"

- include: "provision.yaml"
  when: "state != 'absent'"

- include: "destroy.yaml"
  when: "state == 'absent'"
