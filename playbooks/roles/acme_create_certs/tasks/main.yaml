- name: Generate list of changed certificates
  set_fact:
    acme_txt_changed: '{{ acme_txt_required|map("first")|list|unique }}'

- name: Include ACME validation
  include_tasks: acme.yaml
  loop: "{{ query('dict', ssl_certs) }}"
  loop_control:
    loop_var: cert
  #when: item.key in acme_txt_changed

- name: Create haproxy certs directory
  ansible.builtin.file:
    path: "/etc/ssl/{{ inventory_hostname }}/haproxy"
    state: "directory"
    mode: "0755"

# we only restart haproxy if it's cert files got modified
- name: Prepare haproxy certs
  ansible.builtin.assemble:
    src: "{{ certs_path }}/"
    regexp: ".*{{ cert.key }}(-fullchain.crt|.pem)"
    dest: "{{ certs_path }}/haproxy/{{ cert.key }}.pem"
    group: "{{ haproxy_group | default('99') }}"
    owner: "{{ haproxy_user | default('99') }}"
  loop: "{{ query('dict', ssl_certs) }}"
  loop_control:
    loop_var: cert
  notify:
    - Restart haproxy
