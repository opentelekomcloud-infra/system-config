# TBD (once zuul drops gearman)
- name: Create Zuul SSL Secrets
  community.kubernetes.k8s:
    context: "{{ context }}"
    state: "present"
    namespace: "{{ namespace }}"
    name: "zuul-{{ instance }}"
    api_version: "v1"
    kind: "Secret"
    apply: "yes"
    definition:
      metadata:
        labels:
          app.kubernetes.io/app: "zuul"
          app.kubernetes.io/instance: "{{ instance }}"
          app.kubernetes.io/managed-by: "system-config"
      data:
        gearman-ca.pem: "{{ lookup('file', x509_certs[('zuul-' + instance + '-gearman-client')]['ca']) | string | b64encode }}"
        gearman-client.pem: "{{ lookup('file', x509_certs[('zuul-' + instance + '-gearman-client')]['cert']) | string | b64encode }}"
        gearman-client.key: "{{ lookup('file', x509_certs[('zuul-' + instance + '-gearman-client')]['key']) | string | b64encode }}"
  tags: ["config"]

# TBD (once zuul drops gearman)
- name: Create Zuul Scheduler Secrets
  community.kubernetes.k8s:
    context: "{{ context }}"
    state: "present"
    namespace: "{{ namespace }}"
    name: "zuul-scheduler-{{ instance }}"
    api_version: "v1"
    kind: "Secret"
    apply: "yes"
    definition:
      metadata:
        labels:
          app.kubernetes.io/app: "zuul"
          app.kubernetes.io/instance: "{{ instance }}"
          app.kubernetes.io/managed-by: "system-config"
      data:
        gearman-ca.pem: "{{ lookup('file', x509_certs[('zuul-' + instance + '-gearman-server')]['ca']) | string | b64encode }}"
        gearman-server.pem: "{{ lookup('file', x509_certs[('zuul-' + instance + '-gearman-server')]['cert']) | string | b64encode }}"
        gearman-server.key: "{{ lookup('file', x509_certs[('zuul-' + instance + '-gearman-server')]['key']) | string | b64encode }}"
  tags: ["config"]

- include_tasks: zuul-merger.yaml
  tags: ["config"]
- include_tasks: zuul-scheduler.yaml
  tags: ["config"]
- include_tasks: zuul-web.yaml
  tags: ["config"]
- include_tasks: zuul-executor.yaml
  tags: ["config"]
