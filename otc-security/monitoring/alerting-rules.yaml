# OTC Security Alerting Rules
# Comprehensive alerting configuration for security events

# Critical Security Alerts
critical_security_alerts:
  - name: "DDoS Attack Detection"
    condition: "rate(http_requests_total[1m]) > 1000"
    duration: "30s"
    severity: "critical"
    description: "Potential DDoS attack detected - immediate action required"
    response_actions:
      - "Enable rate limiting"
      - "Contact security team"
      - "Implement geo-blocking if needed"

  - name: "Mass Security Group Violations"
    condition: "rate(security_group_blocks_total[5m]) > 100"
    duration: "1m"
    severity: "critical"
    description: "High volume of security group blocks indicates coordinated attack"
    response_actions:
      - "Review blocked IPs"
      - "Update threat intelligence"
      - "Escalate to security operations"

  - name: "SSL Certificate Compromise"
    condition: "rate(ssl_errors_total[5m]) > 50"
    duration: "2m"
    severity: "critical"
    description: "High SSL error rate may indicate certificate issues or attack"
    response_actions:
      - "Check certificate validity"
      - "Review SSL logs"
      - "Consider certificate rotation"

# High Priority Alerts
high_priority_alerts:
  - name: "Threat Intelligence Hits"
    condition: "rate(threat_intel_blocks_total[5m]) > 10"
    duration: "2m"
    severity: "high"
    description: "Multiple known malicious IPs detected"
    response_actions:
      - "Review threat intelligence sources"
      - "Update security group rules"
      - "Monitor for pattern changes"

  - name: "Unusual Geographic Traffic"
    condition: "country_traffic_percentage > 50"
    duration: "10m"
    severity: "high"
    description: "Abnormal concentration of traffic from single country"
    response_actions:
      - "Analyze traffic patterns"
      - "Consider geo-blocking"
      - "Review legitimate business traffic"

  - name: "Bot Activity Surge"
    condition: "rate(bot_requests_total[15m]) > 100"
    duration: "5m"
    severity: "high"
    description: "Significant increase in automated traffic"
    response_actions:
      - "Enable bot protection"
      - "Update bot detection rules"
      - "Monitor for scraping activity"

# Warning Level Alerts
warning_alerts:
  - name: "Elevated Traffic Volume"
    condition: "rate(http_requests_total[5m]) > 500"
    duration: "5m"
    severity: "warning"
    description: "Traffic volume above normal baseline"
    response_actions:
      - "Monitor for continued growth"
      - "Check system performance"
      - "Prepare scaling if needed"

  - name: "Load Balancer Connection Pressure"
    condition: "lb_active_connections > 8000"
    duration: "2m"
    severity: "warning"
    description: "Load balancer approaching connection limits"
    response_actions:
      - "Monitor connection growth"
      - "Check backend health"
      - "Consider scaling"

  - name: "Failed Authentication Attempts"
    condition: "rate(auth_failures_total[10m]) > 20"
    duration: "5m"
    severity: "warning"
    description: "Increased authentication failures"
    response_actions:
      - "Review authentication logs"
      - "Check for brute force attacks"
      - "Implement account lockouts if needed"

# Infrastructure Health Alerts
infrastructure_alerts:
  - name: "Security Service Degradation"
    condition: "up{job='security-services'} < 1"
    duration: "1m"
    severity: "critical"
    description: "Security monitoring service is down"
    response_actions:
      - "Restart security services"
      - "Check system resources"
      - "Escalate to operations team"

  - name: "Log Processing Delays"
    condition: "log_processing_delay_seconds > 300"
    duration: "5m"
    severity: "warning"
    description: "Security log processing is delayed"
    response_actions:
      - "Check log processing pipeline"
      - "Monitor disk space"
      - "Review system performance"

  - name: "Threat Intelligence Feed Stale"
    condition: "time() - threat_intel_last_update > 7200"
    duration: "0s"
    severity: "warning"
    description: "Threat intelligence feeds haven't updated in 2+ hours"
    response_actions:
      - "Check threat intelligence services"
      - "Verify API credentials"
      - "Manual threat feed update if needed"

# Notification Channels
notification_channels:
  # Critical alerts go to multiple channels
  critical:
    - type: "pagerduty"
      config:
        service_key: "XXXXXXXXXX"
        severity: "critical"

    - type: "email"
      config:
        to: ["security-oncall@otc.example.com"]
        subject: "CRITICAL: OTC Security Alert"

  # High priority alerts
  high:
    - type: "email"
      config:
        to: ["security-team@otc.example.com"]
        subject: "HIGH: OTC Security Alert"

  # Warning alerts
  warning:

# Escalation Policies
escalation_policies:
  security_critical:
    steps:
      - duration: "5m"
        targets: ["security-oncall-primary"]
      - duration: "10m"
        targets: ["security-oncall-secondary", "security-manager"]
      - duration: "15m"
        targets: ["ops-manager", "security-director"]

  security_high:
    steps:
      - duration: "15m"
        targets: ["security-team"]
      - duration: "30m"
        targets: ["security-oncall-primary"]

  infrastructure:
    steps:
      - duration: "10m"
        targets: ["ops-oncall"]
      - duration: "20m"
        targets: ["ops-manager"]

# Alert Suppression Rules
suppression_rules:
  # Suppress duplicate alerts
  - name: "duplicate_suppression"
    condition: "alertname"
    duration: "5m"

  # Suppress alerts during maintenance
  - name: "maintenance_suppression"
    condition: "maintenance_mode == 'true'"
    duration: "24h"

  # Suppress low-priority alerts during incidents
  - name: "incident_suppression"
    condition: "severity == 'warning' AND incident_active == 'true'"
    duration: "1h"

# Auto-remediation Actions
auto_remediation:
  # Automatic IP blocking for DDoS
  ddos_auto_block:
    trigger: "DDoS Attack Detection"
    action: "block_source_ips"
    parameters:
      duration: "1h"
      threshold: "1000 req/min"

  # Automatic rate limiting
  rate_limit_auto:
    trigger: "Elevated Traffic Volume"
    action: "enable_rate_limiting"
    parameters:
      limit: "100 req/min"
      duration: "30m"

  # Automatic scaling
  auto_scale:
    trigger: "Load Balancer Connection Pressure"
    action: "scale_backend_pool"
    parameters:
      scale_factor: 1.5
      max_instances: 10

# Reporting Configuration
reporting:
  # Daily security report
  daily_report:
    schedule: "0 8 * * *"  # 8 AM daily
    recipients: ["security-team@otc.example.com"]
    content:
      - "Alert summary (last 24h)"
      - "Top attack sources"
      - "Threat intelligence updates"
      - "System health metrics"

  # Weekly executive report
  weekly_report:
    schedule: "0 9 * * 1"  # 9 AM Monday
    recipients: ["security-director@otc.example.com", "ciso@otc.example.com"]
    content:
      - "Security posture summary"
      - "Threat landscape analysis"
      - "Security improvements"
      - "Risk assessment updates"

  # Monthly compliance report
  monthly_report:
    schedule: "0 9 1 * *"  # 9 AM first day of month
    recipients: ["compliance@otc.example.com", "audit@otc.example.com"]
    content:
      - "Compliance metrics"
      - "Security control effectiveness"
      - "Audit trail summary"
      - "Regulatory updates"
