# Enhanced Security Groups for OTC Infrastructure
# These configurations extend existing security groups with enhanced protection

# Enhanced Common Security Group with Threat Intelligence
enhanced_common_sg: &enhanced_common_sg
  name: "enhanced_common_sg"
  description: "Enhanced common security group with threat intelligence and rate limiting"
  rules:
    # SSH with rate limiting (existing rule enhanced)
    - protocol: "tcp"
      port_range_min: 22
      port_range_max: 22
      remote_ip_prefix: "0.0.0.0/0"
      direction: "ingress"
      description: "SSH access with rate limiting"

    # HTTPS with DDoS protection
    - protocol: "tcp"
      port_range_min: 443
      port_range_max: 443
      remote_ip_prefix: "0.0.0.0/0"
      direction: "ingress"
      description: "HTTPS with DDoS protection"

    # HTTP with rate limiting
    - protocol: "tcp"
      port_range_min: 80
      port_range_max: 80
      remote_ip_prefix: "0.0.0.0/0"
      direction: "ingress"
      description: "HTTP with rate limiting"

    # Node exporter (monitoring) - restricted
    - protocol: "tcp"
      port_range_min: 9100
      port_range_max: 9100
      remote_ip_prefix: "192.168.0.0/16"
      direction: "ingress"
      description: "Node exporter monitoring"

    # Block known malicious networks (will be updated by automation)
    - protocol: "tcp"
      port_range_min: 1
      port_range_max: 65535
      remote_ip_prefix: "0.0.0.0/32"  # Placeholder for threat intel IPs
      direction: "ingress"
      description: "Block threat intelligence IPs"

# Enhanced Load Balancer Security Group
enhanced_lb_sg: &enhanced_lb_sg
  name: "enhanced_lb_sg"
  description: "Enhanced load balancer security group with WAF-like protection"
  rules:
    # HTTP with enhanced protection
    - protocol: "tcp"
      port_range_min: 80
      port_range_max: 80
      remote_ip_prefix: "0.0.0.0/0"
      direction: "ingress"
      description: "HTTP with WAF protection and rate limiting"

    # HTTPS with enhanced protection
    - protocol: "tcp"
      port_range_min: 443
      port_range_max: 443
      remote_ip_prefix: "0.0.0.0/0"
      direction: "ingress"
      description: "HTTPS with WAF protection and rate limiting"

    # Health check ports
    - protocol: "tcp"
      port_range_min: 8080
      port_range_max: 8080
      remote_ip_prefix: "192.168.0.0/16"
      direction: "ingress"
      description: "Health check endpoint"

    # Block common attack vectors
    - protocol: "tcp"
      port_range_min: 23
      port_range_max: 23
      remote_ip_prefix: "0.0.0.0/0"
      direction: "ingress"
      description: "Block Telnet (deny rule)"

    - protocol: "tcp"
      port_range_min: 3389
      port_range_max: 3389
      remote_ip_prefix: "0.0.0.0/0"
      direction: "ingress"
      description: "Block RDP (deny rule)"

# Enhanced Database Security Group
enhanced_pg_sg: &enhanced_pg_sg
  name: "enhanced_pg_sg"
  description: "Enhanced PostgreSQL security group with access controls"
  rules:
    # PostgreSQL with restricted access
    - protocol: "tcp"
      port_range_min: 5432
      port_range_max: 5432
      remote_ip_prefix: "192.168.0.0/16"
      direction: "ingress"
      description: "PostgreSQL internal access only"

    # Block external database access attempts
    - protocol: "tcp"
      port_range_min: 5432
      port_range_max: 5432
      remote_ip_prefix: "0.0.0.0/0"
      direction: "ingress"
      description: "Block external PostgreSQL access (deny rule)"

# Enhanced Vault Security Group
enhanced_vault_sg: &enhanced_vault_sg
  name: "enhanced_vault_sg"
  description: "Enhanced Vault security group with strict access controls"
  rules:
    # Vault API with enhanced protection
    - protocol: "tcp"
      port_range_min: 8200
      port_range_max: 8200
      remote_ip_prefix: "192.168.0.0/16"
      direction: "ingress"
      description: "Vault API internal access with rate limiting"

    # Vault cluster communication
    - protocol: "tcp"
      port_range_min: 8201
      port_range_max: 8201
      remote_ip_prefix: "192.168.0.0/16"
      direction: "ingress"
      description: "Vault cluster communication"

    # Block external Vault access
    - protocol: "tcp"
      port_range_min: 8200
      port_range_max: 8201
      remote_ip_prefix: "0.0.0.0/0"
      direction: "ingress"
      description: "Block external Vault access (deny rule)"

# Threat Intelligence Security Group (dynamically updated)
threat_intel_sg: &threat_intel_sg
  name: "threat_intel_sg"
  description: "Dynamic security group for threat intelligence blocking"
  rules:
    # This will be populated by automation scripts
    # Example entries (will be replaced by real threat data):
    - protocol: "tcp"
      port_range_min: 1
      port_range_max: 65535
      remote_ip_prefix: "192.0.2.0/24"  # RFC 5737 test network
      direction: "ingress"
      description: "Block Spamhaus DROP list IPs"

    - protocol: "tcp"
      port_range_min: 1
      port_range_max: 65535
      remote_ip_prefix: "198.51.100.0/24"  # RFC 5737 test network
      direction: "ingress"
      description: "Block SANS Storm Center IPs"

# Enhanced security groups for OTC clouds
enhanced_cloud_security_groups:
  # Apply enhanced security to existing clouds
  - cloud: "otc_vault_448_de_eco_infra"
    <<: *enhanced_common_sg
  - cloud: "otc_vault_448_de_eco_infra"
    <<: *enhanced_lb_sg
  - cloud: "otc_vault_448_de_eco_infra"
    <<: *enhanced_pg_sg
  - cloud: "otc_vault_448_de_eco_infra"
    <<: *enhanced_vault_sg
  - cloud: "otc_vault_448_de_eco_infra"
    <<: *threat_intel_sg

  - cloud: "otc_vault_449_de_eco_infra"
    <<: *enhanced_common_sg
  - cloud: "otc_vault_449_de_eco_infra"
    <<: *enhanced_vault_sg
  - cloud: "otc_vault_449_de_eco_infra"
    <<: *threat_intel_sg

  - cloud: "otc_vault_449_nl_eco_infra"
    <<: *enhanced_common_sg
  - cloud: "otc_vault_449_nl_eco_infra"
    <<: *enhanced_vault_sg
  - cloud: "otc_vault_449_nl_eco_infra"
    <<: *threat_intel_sg

  - cloud: "otc_vault_448_de_database"
    <<: *enhanced_common_sg
  - cloud: "otc_vault_448_de_database"
    <<: *enhanced_pg_sg
  - cloud: "otc_vault_448_de_database"
    <<: *threat_intel_sg

  - cloud: "otc_vault_448_de_apimon"
    <<: *enhanced_common_sg
  - cloud: "otc_vault_448_de_apimon"
    <<: *enhanced_pg_sg
  - cloud: "otc_vault_448_de_apimon"
    <<: *threat_intel_sg

  # Zuul pools with enhanced protection
  - cloud: "otc_vault_448_de_zuul_pool1"
    <<: *enhanced_common_sg
  - cloud: "otc_vault_448_de_zuul_pool1"
    <<: *threat_intel_sg

  - cloud: "otc_vault_448_de_zuul_pool2"
    <<: *enhanced_common_sg
  - cloud: "otc_vault_448_de_zuul_pool2"
    <<: *threat_intel_sg

  - cloud: "otc_vault_448_de_zuul_pool3"
    <<: *enhanced_common_sg
  - cloud: "otc_vault_448_de_zuul_pool3"
    <<: *threat_intel_sg

  # CloudMon with enhanced protection
  - cloud: "otccloudmon-de"
    <<: *enhanced_common_sg
  - cloud: "otccloudmon-de"
    <<: *threat_intel_sg

  - cloud: "otccloudmon-nl"
    <<: *enhanced_common_sg
  - cloud: "otccloudmon-nl"
    <<: *threat_intel_sg
