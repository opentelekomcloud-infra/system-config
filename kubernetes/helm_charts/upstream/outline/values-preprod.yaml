---
# Production-ready Outline Wiki Configuration
# Successfully tested and working with community-charts

# Disable PostgreSQL subchart (we use external PostgreSQL)
postgresql:
  enabled: false

# Configure Redis subchart with csi-disk storage
redis:
  enabled: true
  auth:
    enabled: false  # Disable authentication to simplify setup
  master:
    persistence:
      enabled: true
      size: 8Gi
      storageClass: "csi-disk"
  replica:
    replicaCount: 1
    persistence:
      enabled: true
      size: 8Gi
      storageClass: "csi-disk"

outline:
  # Secrets - will be overridden by ArgoCD parameters
  secretKey: "<path:secret/data/outline/app#secretKey>"
  utilsSecret: "<path:secret/data/outline/app#utilsSecret>"
  url: ""  # Will be auto-generated from ingress

  # Keycloak OIDC Authentication - will be overridden by ArgoCD parameters
  auth:
    keycloak:
      enabled: true
      clientId: "<path:secret/data/outline/keycloak#clientId>"
      clientSecret: "<path:secret/data/outline/keycloak#client-secret>"
      baseUrl: "<path:secret/data/outline/keycloak#baseUrl>"
      realmName: "<path:secret/data/outline/keycloak#realm-name>"
      displayName: "Keycloak SSO"
      # usernameClaim: "preferred_username"
      # scopes:
      #   - openid
      #   - profile
      #   - email

  # Use external PostgreSQL (our managed instance)
  externalPostgresql:
    host: "<path:secret/data/outline/postgresql#host>"
    username: "<path:secret/data/outline/postgresql#username>"
    password: "<path:secret/data/outline/postgresql#password>"
    database: "<path:secret/data/outline/postgresql#database>"
    port: 5432  # Default port as integer
    # Use existing secret to bypass password requirements in templates
    existingSecret: "outline-postgresql-secret"

  externalRedis:
    # Use the umbrella chart's Redis service name
    host: "outline-wiki-preprod-redis-master"
    port: 6379
    # No password needed since auth is disabled
    # password: "<path:secret/data/outline/redis#password>"
    # existingSecret: "outline-wiki-preprod-redis"

  # Service configuration
  service:
    enabled: true
    type: ClusterIP
    port: 3000

  # Ingress with TLS
  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-body-size: "50m"
      nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    hosts:
      - host: docs.eco-preprod.tsi-dev.otc-service.com
        paths:
          - path: /
            pathType: ImplementationSpecific
    tls:
      - secretName: outline-tls
        hosts:
          - docs.eco-preprod.tsi-dev.otc-service.com

  # Resource limits
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 512Mi

  # Security contexts
  podSecurityContext:
    fsGroup: 1001
    runAsNonRoot: true

  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 1001
    runAsGroup: 1001

  # File storage configuration
  fileStorage:
    mode: local
    local:
      persistence:
        enabled: true
        size: 50Gi
        storageClass: "csi-disk"
