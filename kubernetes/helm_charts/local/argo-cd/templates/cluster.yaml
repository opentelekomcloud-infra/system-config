{{- if .Values.clusters }}
{{- range $clusterName, $cluster := .Values.clusters }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $clusterName }}
  namespace: {{ $.Release.Namespace }}
  labels:
    argocd.argoproj.io/secret-type: cluster
    app.kubernetes.io/part-of: argocd
    app.kubernetes.io/component: cluster-secret
type: Opaque
stringData:
  name: {{ $cluster.name }}
  server: {{ $cluster.server }}
  config: |
    {"tlsClientConfig":{"insecure":false,
        {{- $tlsConfig := list -}}
        {{- if $cluster.config.tlsClientConfig.certData -}}
          {{- $tlsConfig = append $tlsConfig (printf "\"certData\":\"<path:secret/data/argocd/clusters/%s#certData>\"" $cluster.name) -}}
        {{- end -}}
        {{- if $cluster.config.tlsClientConfig.keyData -}}
          {{- $tlsConfig = append $tlsConfig (printf "\"keyData\":\"<path:secret/data/argocd/clusters/%s#keyData>\"" $cluster.name) -}}
        {{- end -}}
        {{- if $cluster.config.tlsClientConfig.caData -}}
          {{- $tlsConfig = append $tlsConfig (printf "\"caData\":\"<path:secret/data/argocd/clusters/%s#caData>\"" $cluster.name) -}}
        {{- end -}}
        {{- if $cluster.config.tlsClientConfig.serverName -}}
          {{- $tlsConfig = append $tlsConfig (printf "\"serverName\":\"<path:secret/data/argocd/clusters/%s#serverName>\"" $cluster.name) -}}
        {{- end -}}
        {{- if $tlsConfig -}}
          {{ join "," $tlsConfig }}
        {{- end }}}}
{{- end }}
{{- end }}
