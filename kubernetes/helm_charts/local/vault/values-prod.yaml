# Vault additional manifests configuration for otcinfra2 (production)
# This chart provides supplementary resources not available in upstream Vault Helm chart
#
# NetworkPolicy: deny-all by default, only explicitly listed consumers can reach Vault.
# Remote clusters (otcinfra1, otcci) access Vault via ingress-nginx.

networkPolicy:
  enabled: true

  # Pod selector for Vault pods
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vault

  # Explicit list of namespaces/pods allowed to connect to Vault on port 8200.
  # Each entry creates a separate ingress rule. All unlisted namespaces are denied.
  allowedConsumers:
    # ArgoCD repo-server — runs argocd-vault-plugin for secret injection
    - namespace: argocd
      podSelector:
        app.kubernetes.io/name: argocd-repo-server

    # Backstage — vault-agent sidecar (auth/kubernetes_otcinfra2)
    - namespace: backstage

    # Circle Partner Navigator — vault-agent sidecar (auth/kubernetes_otcinfra2)
    - namespace: circle-partner-navigator

    # Dependency Track — vault-agent sidecar for postgres secrets (auth/kubernetes_otcinfra2)
    - namespace: dependencytrack

    # Eyes on Docs — vault-agent sidecar (auth/kubernetes_otcinfra2)
    - namespace: eyes-on-docs

    # mCaptcha — vault-agent sidecar (auth/kubernetes_otcinfra2)
    - namespace: mcaptcha

    # Prometheus — scrape Vault /v1/sys/metrics
    - namespace: monitoring
      podSelector:
        app.kubernetes.io/name: prometheus

    # ZITADEL — vault-agent sidecar (auth/kubernetes_otcinfra2)
    - namespace: zitadel
      podSelector:
        app.kubernetes.io/name: zitadel

  # Ingress controller — required for remote clusters to reach Vault via LB
  # Remote consumers:
  #   otcinfra1: anubis, docsportal, swift-proxy, umami (auth/kubernetes_otcinfra1)
  #   otcci:    zuul (auth/kubernetes_otcci)
  allowIngress:
    enabled: true
    namespace: default
    podSelector:
      app.kubernetes.io/name: ingress-nginx

  # Vault API port
  vaultPort: 8200

  # Vault cluster port (for raft replication)
  clusterPort: 8201

# Auto-unseal configuration
# The unsealer sidecar watches for sealed state and auto-unseals using K8s secret
#
# Required secret format (vault-unseal-keys in vault namespace):
# Create the secret with unseal keys from 'vault operator init':
#
#   kubectl -n vault create secret generic vault-unseal-keys \
#     --from-literal=vault-root=<root-token> \
#     --from-literal=vault-unseal-0=<key1> \
#     --from-literal=vault-unseal-1=<key2> \
#     --from-literal=vault-unseal-2=<key3> \
#     --from-literal=vault-unseal-3=<key4> \
#     --from-literal=vault-unseal-4=<key5>
#
# See: https://bank-vaults.dev/docs/unseal-keys/

# Unsealer RBAC - grants access to the vault-unseal-keys secret
unsealer:
  enabled: true
  secretName: vault-unseal-keys
  # The upstream vault chart creates ServiceAccount named after the release
  serviceAccountName: vault
