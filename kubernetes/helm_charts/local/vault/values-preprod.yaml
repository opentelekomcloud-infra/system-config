# Vault additional manifests configuration for preprod
# This chart provides supplementary resources not available in upstream Vault Helm chart

networkPolicy:
  enabled: true
  
  # Pod selector for Vault pods
  podSelector:
    matchLabels:
      app.kubernetes.io/name: vault
  
  # Namespaces allowed to access Vault (by label)
  # Add label: vault-access: "true" to namespaces that need Vault access
  allowedNamespaces:
    labelSelector:
      matchLabels:
        vault-access: "true"
  
  # Fine-grained access: specific pods in specific namespaces
  # Only argocd-repo-server needs Vault access (runs vault-plugin)
  allowedPods:
    - namespace: argocd
      podSelector:
        app.kubernetes.io/name: argocd-repo-server
  
  # Allow Prometheus to scrape Vault metrics
  allowPrometheus: true
  prometheusNamespace: monitoring
  
  # Vault API port
  vaultPort: 8200
  
  # Vault cluster port (for raft replication)
  clusterPort: 8201

# Auto-unseal configuration
# Uses a CronJob to automatically unseal Vault if it becomes sealed
autoUnseal:
  enabled: true
  
  # Check every minute
  schedule: "*/1 * * * *"
  
  # Vault address (internal cluster address)
  vaultAddr: "http://vault.vault.svc.cluster.local:8200"
  
  # Skip TLS verification (internal communication)
  skipVerify: "true"
  
  # Vault image for the unseal job
  image: hashicorp/vault:1.19.0
  
  # Service account to use (uses existing vault SA)
  serviceAccountName: vault
  createServiceAccount: false
  
  # Secret containing unseal keys
  # Must have keys: UNSEAL_KEY_1, UNSEAL_KEY_2, UNSEAL_KEY_3, etc.
  unsealKeysSecret: vault-unseal-keys
  
  # Number of keys required to unseal (Shamir threshold)
  keyThreshold: 3
