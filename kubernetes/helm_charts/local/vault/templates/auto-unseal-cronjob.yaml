{{- if .Values.vaultConfig.enabled }}
{{- if .Values.vaultConfig.autoUnseal.enabled }}
# CronJob to check Vault seal status and unseal if needed
apiVersion: batch/v1
kind: CronJob
metadata:
  name: vault-auto-unseal
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "vault-additional.labels" . | nindent 4 }}
spec:
  schedule: "{{ .Values.vaultConfig.autoUnseal.schedule }}"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: {{ .Values.vaultConfig.autoUnseal.serviceAccountName }}
          restartPolicy: OnFailure
          containers:
            - name: unseal
              image: {{ .Values.vaultConfig.autoUnseal.image }}
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  
                  echo "Checking Vault seal status..."
                  
                  if vault status 2>&1 | grep -q "Sealed.*true"; then
                    echo "Vault is sealed, attempting to unseal..."
                    
                    # Unseal using keys from secret
                    {{- range $i := until (.Values.vaultConfig.autoUnseal.keyThreshold | int) }}
                    vault operator unseal "$UNSEAL_KEY_{{ add $i 1 }}"
                    {{- end }}
                    
                    echo "Unseal commands executed"
                  else
                    echo "Vault is already unsealed or not initialized"
                  fi
                  
                  vault status
              env:
                - name: VAULT_ADDR
                  value: "{{ .Values.vaultConfig.autoUnseal.vaultAddr }}"
                - name: VAULT_SKIP_VERIFY
                  value: "{{ .Values.vaultConfig.autoUnseal.skipVerify }}"
              envFrom:
                - secretRef:
                    name: {{ .Values.vaultConfig.autoUnseal.unsealKeysSecret }}
{{- end }}
{{- end }}
