{{- if .Values.urlRewriter.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "swift-proxy.fullname" . }}-url-rewriter
  labels:
    {{- include "swift-proxy.labels" . | nindent 4 }}
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }
    
    http {
      server {
        listen 8081;
        
        # Remove trailing slash from index.html URLs - always redirect to HTTPS
        location ~ ^(.*index\.html)/$ {
          return 301 https://$host$1;
        }
        
        # Serve index.html for directory URLs (ending with /)
        location ~ ^(.+)/$ {
          proxy_pass http://{{ include "swift-proxy.fullname" . }}:{{ .Values.proxy.port }}$1/index.html;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Proxy all other requests to Swift
        location / {
          proxy_pass http://{{ include "swift-proxy.fullname" . }}:{{ .Values.proxy.port }};
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
      }
    }
{{- end }}
