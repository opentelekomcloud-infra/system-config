apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-preprod-initdb
  namespace: postgres
  labels:
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/instance: postgresql-preprod
data:
  01_init_database.sql: |
    -- Create zitadel database and user
    CREATE USER "zitadel" WITH PASSWORD '<path:secret/data/postgresql#user-password>';
    CREATE DATABASE "zitadel_db" OWNER "zitadel";
    GRANT ALL PRIVILEGES ON DATABASE "zitadel_db" TO "zitadel";

    -- Create replication user
    CREATE ROLE repl_user WITH REPLICATION LOGIN PASSWORD '<path:secret/data/postgresql#replication-password>';

    -- Enable pgaudit extension
    CREATE EXTENSION IF NOT EXISTS pgaudit;