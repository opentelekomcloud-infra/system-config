---
apiVersion: v1
kind: Secret
metadata:
  name: backstage-secret
type: Opaque
stringData:
  # Database configuration
  POSTGRES_HOST: <path:secret/data/postgresql/backstage#host>
  POSTGRES_USER: <path:secret/data/postgresql/backstage#username>
  POSTGRES_PASSWORD: <path:secret/data/postgresql/backstage#password>

  # Backend configuration
  BACKEND_SECRET: <path:secret/data/backstage/config#backend_secret>
  BACKSTAGE_BASE_URL: https://<path:secret/data/backstage/config#base_url>

  # GitHub Auth configuration
  AUTH_GITHUB_CLIENT_ID: ""
  AUTH_GITHUB_CLIENT_SECRET: ""

  # GitHub Integration configuration
  GITHUB_APP_ID: ""
  GITHUB_CLIENT_ID: ""
  GITHUB_CLIENT_SECRET: ""
  GITHUB_WEBHOOK_SECRET: ""
  GITHUB_PRIVATE_KEY: ""

  # Gitea configuration
  GITEA_CLIENT_ID: <path:secret/data/backstage/gitea#clientId>
  GITEA_CLIENT_SECRET: <path:secret/data/backstage/gitea#clientSecret>
  GITEA_TOKEN: <path:secret/data/backstage/gitea#token>
  GITEA_URL: <path:secret/data/gitea/config#gitea_address>

  # Zitadel/OIDC configuration
  ZITADEL_PROJECT_ID: <path:secret/data/backstage/zitadel#projectId>
  ZITADEL_CLIENT_ID: <path:secret/data/backstage/zitadel#clientId>
  ZITADEL_CLIENT_SECRET: <path:secret/data/backstage/zitadel#clientSecret>
  ZITADEL_URL: https://<path:secret/data/zitadel/config#base_url>

  # Kubernetes configuration
  K8S_INFRA2_TOKEN: ""

  # Grafana configuration
  GRAFANA_TOKEN: ""

  # Dependency Track configuration
  DEPENDENCYTRACK_TOKEN: ""

  # Secure configuration file - this replaces the ConfigMap
  app-config.production.yaml: |
    app:
      baseUrl: ${BACKSTAGE_BASE_URL}

    backend:
      auth:
        dangerouslyDisableDefaultAuthPolicy: ${DANGEROUS_DISABLE_AUTH_POLICY}
      baseUrl: ${BACKSTAGE_BASE_URL}
      listen:
        port: 7007
      cors:
        origin: ${BACKSTAGE_BASE_URL}
      database:
        client: pg
        connection:
          host: ${POSTGRES_HOST}
          port: ${POSTGRES_PORT}
          user: ${POSTGRES_USER}
          password: ${POSTGRES_PASSWORD}
          database: backstage

    auth:
      environment: ${AUTH_ENVIRONMENT}
      providers:
        oauth2Proxy: {}
        github:
          development:
            clientId: ${GITHUB_CLIENT_ID}
            clientSecret: ${GITHUB_CLIENT_SECRET}
          production:
            clientId: ${GITHUB_CLIENT_ID}
            clientSecret: ${GITHUB_CLIENT_SECRET}
        gitea:
          development:
            metadataUrl: https://${GITEA_URL}/.well-known/openid-configuration
            authorizationUrl: https://${GITEA_URL}/login/oauth/authorize
            tokenUrl: https://${GITEA_URL}/login/oauth/access_token
            clientId: ${GITEA_CLIENT_ID}
            clientSecret: ${GITEA_CLIENT_SECRET}

    catalog:
      providers:
        zitadelOrg:
          default:
            baseUrl: ${ZITADEL_URL}
            projectId: ${ZITADEL_PROJECT_ID}
            clientId: ${ZITADEL_CLIENT_ID}
            clientSecret: ${ZITADEL_CLIENT_SECRET}
      rules:
        - allow: [Component, System, API, Resource, Location, Group, User, Template]
      locations:
        - type: url
          target: https://${GITEA_URL}/backstage/catalog/contents/blob/main/otc-catalog.yaml
          rules:
            - allow: [Domain, Group, User, Location, Component, Resource, API, System]
        - type: url
          target: https://${GITEA_URL}/backstage/catalog-compute/contents/blob/main/catalog.yaml
        - type: url
          target: https://${GITEA_URL}/backstage/catalog-ecosystem/contents/blob/main/catalog.yaml
        - type: url
          target: https://github.com/opentelekomcloud-infra/backstage-templates/blob/main/catalog.yaml
          rules:
            - allow: [Template]

    integrations:
      gitea:
        - host: ${GITEA_URL}
          password: ${GITEA_TOKEN}
      github:
        - host: github.com
          apps:
            - appId: ${GITHUB_APP_ID}
              clientId: ${GITHUB_CLIENT_ID}
              clientSecret: ${GITHUB_CLIENT_SECRET}
              webhookSecret: ${GITHUB_WEBHOOK_SECRET}
              privateKey: |
                ${GITHUB_PRIVATE_KEY}

    kubernetes:
      serviceLocatorMethod:
        type: 'multiTenant'
      clusterLocatorMethods:
        - type: 'config'
          clusters:
            - name: ""
              authProvider: 'serviceAccount'
              skipTLSVerify: true
              skipMetricsLookup: true
              url: ''
              serviceAccountToken: ${K8S_INFRA2_TOKEN}

    proxy:
      '/grafana/api':
        target: https://dashboard.eco-preprod.tsi-dev.otc-service.com
        headers:
          Authorization: "Bearer ${GRAFANA_TOKEN}"
      '/dependencytrack':
        target: https://dependencytrack.eco-preprod.tsi-dev.otc-service.com
        allowedMethods: ['GET']
        headers:
          X-Api-Key: "${DEPENDENCYTRACK_TOKEN}"
      '/quay/api':
        target: 'https://quay.io'
        headers:
          X-Requested-With: 'XMLHttpRequest'
