apiVersion: batch/v1
kind: CronJob
metadata:
  name: giji-bulk-import
spec:
  concurrencyPolicy: Forbid
  schedule: "0 23 3 9 *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccount: "giji"
          restartPolicy: OnFailure
          initContainers:
            - name: "vault-agent"
              command:
                - "sh"
                - "-c"
                - "vault agent -config=/etc/vault/vault-agent.hcl -exit-after-auth=true"
              env:
                - name: "VAULT_ADDR"
                  value: "https://vault-lb.eco.tsi-dev.otc-service.com:8200"
              image: "hashicorp/vault"
              resources:
                limits:
                  cpu: "100m"
                  memory: "100Mi"
                requests:
                  cpu: "50m"
                  memory: "50Mi"
              volumeMounts:
                - mountPath: "/etc/vault"
                  name: "vault-agent-config"
                - mountPath: "/secrets"
                  name: "secrets"
                - mountPath: "/var/run/secrets/tokens"
                  name: "k8-tokens"
                  readOnly: true
          containers:
            - name: giji-bulk-import
              image: quay.io/opentelekomcloud/giji
              imagePullPolicy: IfNotPresent
              command:
              - "/bin/sh"
              - "-c"
              - "source /secrets/giji-env; python3 bulk_import.py"
              volumeMounts:
                - mountPath: "/secrets"
                  name: "secrets"
          volumes:
            - name: vault-agent-config
              configMap:
                defaultMode: 420
                name: giji-vault-config
            - name: secrets
              emptyDir: {}
            - name: "k8-tokens"
              projected:
                defaultMode: 420
                sources:
                - serviceAccountToken:
                    expirationSeconds: 7200
                    path: "vault-token"
