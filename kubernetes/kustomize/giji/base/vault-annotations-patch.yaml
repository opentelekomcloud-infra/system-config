apiVersion: batch/v1
kind: CronJob
metadata:
  name: placeholder
spec:
  jobTemplate:
    spec:
      template:
        metadata:
          annotations:
            vault.hashicorp.com/agent-inject: "true"
            vault.hashicorp.com/role: "giji"

            # Inject Jira certificate file
            vault.hashicorp.com/agent-inject-secret-jira-cert: "secret/data/jira/autoecobot"
            vault.hashicorp.com/agent-inject-template-jira-cert: |
              {{- with secret "secret/data/jira/autoecobot" -}}
              {{ .Data.data.jira_pem }}
              {{- end }}
            vault.hashicorp.com/agent-inject-file-jira-cert: "jira-cert.pem"
            vault.hashicorp.com/agent-inject-perms-jira-cert: "0600"

            # Inject Jira private key file
            vault.hashicorp.com/agent-inject-secret-jira-key: "secret/data/jira/autoecobot"
            vault.hashicorp.com/agent-inject-template-jira-key: |
              {{- with secret "secret/data/jira/autoecobot" -}}
              {{ .Data.data.jira_key }}
              {{- end }}
            vault.hashicorp.com/agent-inject-file-jira-key: "jira-key.pem"
            vault.hashicorp.com/agent-inject-perms-jira-key: "0600"

            # Inject environment variables - shared config
            vault.hashicorp.com/agent-inject-secret-giji-env: "secret/data/giji/config"
            vault.hashicorp.com/agent-inject-template-giji-env: |
              {{- with secret "secret/data/github/otcbot" -}}
              export GITHUB_TOKEN="{{ .Data.data.otcbot_giji_token }}"
              {{- end }}
              {{- with secret "secret/data/helpcenter/monitoring/github" -}}
              export GITHUB_API_URL="{{ .Data.data.github_api_url }}"
              export GITHUB_ORGS="{{ .Data.data.github_orgs }}"
              {{- end }}
              {{- with secret "secret/data/helpcenter/monitoring/postgresql" -}}
              export DB_HOST="{{ .Data.data.host }}"
              export DB_PORT="{{ .Data.data.port }}"
              export DB_CSV="{{ .Data.data.dbname }}"
              export DB_USER="{{ .Data.data.username }}"
              export DB_PASSWORD="{{ .Data.data.password }}"
              {{- end }}
              {{- with secret "secret/data/gitea" -}}
              export BASE_GITEA_URL="{{ .Data.data.base_url }}"
              {{- end }}
              {{- with secret "secret/data/jira/autoecobot" -}}
              export JIRA_API_URL="{{ .Data.data.jira_api_url }}"
              export JIRA_TOKEN="{{ .Data.data.jira_api_key }}"
              export JIRA_CERT_PATH="/vault/secrets/jira-cert.pem"
              export JIRA_KEY_PATH="/vault/secrets/jira-key.pem"
              {{- end }}
              {{- with secret "secret/data/giji/master_component" -}}
              export DEH="{{ .Data.data.dedicated-host }}"
              export ASG="{{ .Data.data.auto-scaling }}"
              export ECS="{{ .Data.data.elastic-cloud-server }}"
              export IMS="{{ .Data.data.image-management-service }}"
              export BMS="{{ .Data.data.bare-metal-server }}"
              export RDS="{{ .Data.data.relational-database-service }}"
              export OPENGAUSS="{{ .Data.data.gaussdb-opengauss }}"
              export GEMINIDB="{{ .Data.data.geminidb }}"
              export MYSQL="{{ .Data.data.gaussdb-mysql }}"
              export DRS="{{ .Data.data.data-replication-service }}"
              export DAS="{{ .Data.data.data-admin-service }}"
              export DDM="{{ .Data.data.distributed-database-middleware }}"
              export DDS="{{ .Data.data.document-database-service }}"
              {{- end }}
