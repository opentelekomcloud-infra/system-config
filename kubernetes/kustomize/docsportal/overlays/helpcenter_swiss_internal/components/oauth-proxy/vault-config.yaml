apiVersion: v1
kind: ConfigMap
metadata:
  name: docsportal-oauth-proxy-vault-config
  namespace: hc-internal
data:
  vault-agent.hcl: |
    exit_after_auth = true
    pid_file = "/home/vault/pidfile"

    auto_auth {
      method "kubernetes" {
        mount_path = "auth/kubernetes"
        config = {
          role = "docsportal-helpcenter-swiss-internal"
          token_path = "/var/run/secrets/tokens/vault-token"
        }
      }

      sink "file" {
        config = {
          path = "/home/vault/.vault-token"
        }
      }
    }

    template {
      source = "/etc/vault/oauth2-proxy.cfg.tpl"
      destination = "/secrets/oauth2-proxy.cfg"
    }

  oauth2-proxy.cfg.tpl: |
    http_address = "0.0.0.0:4180"
    provider = "oidc"
    redirect_url = "https://docs-swiss-int.otc-service.com/oauth2/callback"

    # Restrict to only allow docsportal upstream - SECURITY CRITICAL
    upstreams = [
        "http://docsportal-helpcenter-swiss-internal:8080"
    ]

    {{- with secret "secret/data/docsportal-swiss/oauth2-proxy" }}
    client_id = "{{ .Data.data.client_id }}"
    client_secret = "{{ .Data.data.client_secret }}"
    cookie_secret = "{{ .Data.data.cookie_secret }}"
    {{- end }}

    oidc_issuer_url = "https://identity.eco.tsi-dev.otc-service.com/v3/auth/OS-FEDERATION/identity_providers/sso/protocols/oidc"

    email_domains = ["*"]
    cookie_domains = [".otc-service.com"]
    whitelist_domains = [".otc-service.com"]

    cookie_secure = true
    cookie_httponly = true
    cookie_samesite = "lax"

    skip_provider_button = true
    pass_basic_auth = false
    pass_access_token = true
    pass_user_headers = true

    set_xauthrequest = true
    set_authorization_header = true

    reverse_proxy = true
    real_client_ip_header = "X-Real-IP"
