---
# Nodepool configuration for Zuul preprod environment
# Debian-only configuration - simplified to single Debian Bookworm image

elements-dir: /etc/nodepool/elements
images-dir: /opt/nodepool/images

zookeeper-servers:
  - host: zookeeper.zuul.svc.cluster.local
    port: 2281

zookeeper-tls:
  cert: /tls/client/tls.crt
  key: /tls/client/tls.key
  ca: /tls/client/ca.crt

labels:
  - name: debian
    min-ready: 0
    max-ready-age: 3600

  - name: zuul-debian
    min-ready: 0

providers:
  # OpenStack providers for VM-based nodes (disabled for preprod)
  # - name: otcci-pool1
  #   driver: openstack
  #   cloud: otcci-pool1
  #   boot-timeout: 300
  #   launch-timeout: 600
  #   launch-retries: 3
  #   image-name-format: '{image_name}-{timestamp}'
  #   rate: 1.0
  #   diskimages:
  #     - name: debian-bookworm
  #       config-drive: true
  #   pools:
  #     - name: main
  #       max-servers: 10
  #       labels:
  #         - name: debian
  #           diskimage: debian-bookworm
  #           flavor-name: s3.medium.4
  #           key-name: nodepool

  # Kubernetes provider for pod-based nodes (in-cluster) - for linters only
  - name: preprod-k8s
    driver: kubernetes
    max-servers: 5
    context: preprod
    pools:
      - name: default
        labels:
          - name: zuul-debian
            type: pod
            spec:
              imagePullSecrets:
                - name: quay-image-pull-secret
              securityContext:
                runAsUser: 1000
                runAsGroup: 1000
                fsGroup: 1000
              volumes:
                - name: zuul-ssh-keys
                  secret:
                    secretName: zuul-ssh-keys
                    defaultMode: 0600
                - name: zuul-home
                  emptyDir: {}
              containers:
                - name: zuul-debian
                  image: quay.io/opentelekomcloud/python-tox:latest
                  imagePullPolicy: Always
                  command: ["/bin/sh", "-c"]
                  args: ["sleep infinity"]
                  env:
                    - name: HOME
                      value: /home/zuul
                    - name: USER
                      value: zuul
                  volumeMounts:
                    - name: zuul-ssh-keys
                      mountPath: /etc/zuul-ssh-keys
                      readOnly: true
                    - name: zuul-home
                      mountPath: /home/zuul
                  resources:
                    requests:
                      cpu: "1"
                      memory: "1024Mi"
                    limits:
                      cpu: "1"
                      memory: "1024Mi"
            python-path: /usr/bin/python3
            shell-type: /bin/bash
<<<<<<< HEAD
<<<<<<< HEAD
            context: preprod
=======
=======
            context: preprod
>>>>>>> 9cfe9caa (Add context: preprod to pod-debian label)
            # Mount shared NFS storage directly (not via PVC)
            # Direct NFS mount works across all namespaces
            volumes:
              - name: zuul-builds-shared
                nfs:
                  server: 192.168.150.233
                  path: /builds
            volume-mounts:
              - name: zuul-builds-shared
                mountPath: /var/lib/zuul/builds
>>>>>>> b29e9324 (Add shell-type to pod-debian label for proper kubectl exec connection)

diskimages:
  - name: debian-bookworm
    formats:
      - raw
    rebuild-age: 86400
    env-vars:
      TMPDIR: /opt/dib_tmp
      DIB_CHECKSUM: '1'
      DIB_IMAGE_CACHE: /opt/dib_cache
      DIB_APT_LOCAL_CACHE: '0'
      DIB_DISABLE_APT_CLEANUP: '1'
      DIB_DISTRIBUTION_MIRROR: http://deb.debian.org/debian
      DIB_RELEASE: bookworm
    elements:
      - debian-minimal
      - vm
      - simple-init
        - growroot
        - openssh-server
        - nodepool-base
# Test for PR 1481 check pipeline
# Test after zuul-jobs load-branch fix
# Test after otc-tox parent fix
# Test after changing otc-tox to inherit from unittests
