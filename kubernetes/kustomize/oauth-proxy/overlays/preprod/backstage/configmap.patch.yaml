---
apiVersion: v1
kind: ConfigMap
metadata:
  name: oauth2-proxy-config
data:
  oauth2-proxy.cfg: |
    # Network configuration
    http_address = "0.0.0.0:4180"

    # OIDC Provider configuration
    provider = "oidc"
    oidc_issuer_url = "https://zitadel.eco-preprod.tsi-dev.otc-service.com"
    skip_oidc_discovery = false
    oidc_jwks_url = "https://zitadel.eco-preprod.tsi-dev.otc-service.com/oauth/v2/keys"

    # Application configuration
    redirect_url = "https://backstage-dev.eco-preprod.tsi-dev.otc-service.com/oauth2/callback"
    whitelist_domains = [
        "backstage-dev.eco-preprod.tsi-dev.otc-service.com"
    ]
    email_domains = [
        "telekom.de",
        "t-systems.com"
    ]
    upstreams = [
        "http://backstage:7007"
    ]

    # Session and Redis configuration
    session_store_type = "redis"
    redis_connection_url = "redis://redis:6379"

    # Security headers and cookie settings
    cookie_secure = true
    cookie_httponly = true
    cookie_samesite = "lax"
    cookie_expire = "24h"
    cookie_refresh = "1h"

    # Request validation
    skip_auth_regex = []
    pass_basic_auth = false
    pass_access_token = false
    pass_authorization_header = false
    set_authorization_header = false
    set_xauthrequest = true

    # Logging and monitoring
    request_logging = true
    auth_logging = true
    silence_ping_logging = true

    # OIDC specific security settings
    insecure_oidc_allow_unverified_email = false
    oidc_email_claim = "email"
    oidc_groups_claim = "urn:zitadel:iam:org:project:roles"

    # Secrets (resolved by ArgoCD Vault Plugin)
    client_id = "<path:secret/data/backstage/oidc#client_id>"
    client_secret = "<path:secret/data/backstage/oidc#client_secret>"
    cookie_secret = "<path:secret/data/backstage/oidc#cookie_secret>"

    # Group-based access control for backstage
    allowed_groups = [
        "argocd_admins"
    ]
