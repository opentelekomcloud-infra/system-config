---
apiVersion: v1
kind: ConfigMap
metadata:
  name: oauth2-proxy-config
data:
  oauth2-proxy.cfg: |
    # OIDC Provider configuration
    provider = "oidc"
    oidc_issuer_url = "https://<path:secret/data/zitadel/config#base_url>"
    skip_oidc_discovery = false
    oidc_jwks_url = "https://<path:secret/data/zitadel/config#base_url>/oauth/v2/keys"

    # Application configuration
    http_address = "0.0.0.0:4180"
    redirect_url = "https://<path:secret/data/backstage/config#base_url>/oauth2/callback"
    whitelist_domains = [
        "<path:secret/data/backstage/config#base_url>"
    ]
    email_domains = [
        "telekom.de",
        "t-systems.com"
    ]
    upstreams = [
        "http://backstage.backstage.svc.cluster.local:80"
    ]

    # OIDC specific security settings
    insecure_oidc_allow_unverified_email = false
    oidc_email_claim = "email"
    oidc_groups_claim = "urn:zitadel:iam:org:project:roles"
    oidc_extra_audiences = []
    scope = "openid profile email groups urn:zitadel:iam:org:project:roles urn:zitadel:iam:user:metadata"

    # Secrets (resolved by ArgoCD Vault Plugin)
    client_id = "<path:secret/data/backstage/zitadel#clientId>"
    client_secret = "<path:secret/data/backstage/zitadel#clientSecret>"
    cookie_secret = "<path:secret/data/backstage/zitadel#cookieSecret>"

    # Email-based access control for backstage
    pass_authorization_header = true
    pass_user_headers = true

    # Group-based access control for backstage
    # allowed_groups = [
    #     "backstage_admins"
    # ]

    # Allow specific users (add your email here)
    authenticated_emails_file = "/dev/null"
