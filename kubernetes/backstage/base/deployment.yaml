apiVersion: apps/v1
kind: Deployment
metadata:
  name: backstage
  labels:
    app.kubernetes.io/component: backstage
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: backstage
  template:
    metadata:
      labels:
        app.kubernetes.io/component: backstage
    spec:
      imagePullSecrets:
        - name: giteacred
      terminationGracePeriodSeconds: 10
      containers:
        - name: backstage
          image: backstage
          # imagePullPolicy: Always
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 7007
          envFrom:
            - secretRef:
                name: backstage-config
          env:
            - name: LOG_LEVEL
              value: debug
          volumeMounts:
            - name: gh-app
              mountPath: /app/github-app-backstage-otc-credentials.yaml
              subPath: github-app-backstage-otc-credentials.yaml
              readOnly: true

        - name: oauth
          image: quay.io/oauth2-proxy/oauth2-proxy:v7.2.1
          imagePullPolicy: IfNotPresent
          ports:
          - name: oauth2-proxy
            containerPort: 4180
            protocol: TCP
          args:
            - '--provider=oidc'
            - '--email-domain=*'
            - '--upstream=http://localhost:7007'
            - '--http-address=0.0.0.0:4180'
            - '--redirect-url=https://backstage.eco.tsi-dev.otc-service.com/oauth2/callback'
            - '--session-store-type=redis'
            - '--redis-connection-url=redis://redis:6379'
            - '--insecure-oidc-allow-unverified-email'
          env:
            - name: OAUTH2_PROXY_CLIENT_ID
              value: backstage
            - name: OAUTH2_PROXY_CLIENT_SECRET
              value: TQLGl6HuXTSQUaKXTadbeHkLTNIZfTO2
            - name: OAUTH2_PROXY_COOKIE_SECRET
              value: 'acWGdeo3fd$dvh.w'
            - name: OAUTH2_PROXY_OIDC_ISSUER_URL
              value: 'https://keycloak.eco.tsi-dev.otc-service.com/realms/eco'
            - name: OAUTH2_PROXY_SSL_INSECURE_SKIP_VERIFY
              value: 'true'

      volumes:
        - name: gh-app
          secret:
            secretName: backstage-gh-app
        - name: cfg
          configMap:
            name: backstage
