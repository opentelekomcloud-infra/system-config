proxy_backends:
  - name: "graphite-apimon"
    options:
      - "http-send-name-header Host"
      # NOTE: try to perform simliest query
      - "option httpchk HEAD /metrics/find?query=*"
      - "default-server check weight 100"
    domain_names:
      - "graphite.eco.tsi-dev.otc-service.com"
      - "graphite1.eco.tsi-dev.otc-service.com"
      - "graphite2.eco.tsi-dev.otc-service.com"
      - "graphite3.eco.tsi-dev.otc-service.com"
    servers:
      - name: "graphite1"
        address: "192.168.191.55:80"
        opts: "cookie graphite1"
      - name: "graphite2"
        address: "192.168.14.159:443"
        opts: "ssl verify none cookie graphite2"
      - name: "graphite3"
        address: "192.168.151.11:443"
        opts: "ssl verify none cookie graphite3"

  - name: "graphite-ca"
    options:
      - "option httpchk GET /lb_check"
      # NOTE: HealthCheck of K8 apps is not working good with http-send-name-header Host option
      # K8 deployed apps require explicit sending Host header
      - "http-check send hdr Host graphite-ca.eco.tsi-dev.otc-service.com"
      # Use all available backup servers instead of first one
      - "option allbackups"
      - "default-server check weight 100"
    domain_names:
      - "graphite-ca.eco.tsi-dev.otc-service.com"
    servers:
      - name: "graphite-otcinfra"
        address: "192.168.170.249:443"
        opts: "ssl verify none cookie graphite-otcinfra"
      - name: "graphite1"
        address: "192.168.191.55:8082"
        opts: "cookie graphite1 backup"
      - name: "graphite2"
        address: "192.168.14.159:8082"
        opts: "cookie graphite2 backup"
      - name: "graphite3"
        address: "192.168.151.11:8082"
        opts: "cookie graphite3 backup"
      - name: "graphite4"
        address: "192.168.14.241:8082"
        opts: "cookie graphite4 backup"

  - name: "dashboard"
    options:
      - "http-send-name-header Host"
      - "option httpchk HEAD /api/health"
      - "default-server check weight 100"
    domain_names:
      - "dashboard.tsi-dev.otc-service.com"
      - "apimon.tsi-dev.otc-service.com"
      - "apimon.eco.tsi-dev.otc-service.com"
    servers:
      - name: "web3"
        address: "192.168.2.52:3000"
        opts: "cookie web3"
      - name: "dashboard.infra.eco.tsi-dev.otc-service.com"
        address: "dashboard.infra.eco.tsi-dev.otc-service.com:443"
        opts: "ssl verify none cookie infra sni req.hdr(Host)"
      - name: "dashboard.apps.osinfra-mirror.eco.tsi-dev.otc-service.com"
        address: "dashboard.apps.osinfra-mirror.eco.tsi-dev.otc-service.com:443"
        opts: "ssl verify none cookie osinfra-mirror sni req.hdr(Host)"

  - name: "alerta"
    options:
      - "http-send-name-header Host"
      # NOTE: trailing slash avoids redirect
      - "option httpchk GET /api/"
      - "default-server check weight 100"
    domain_names:
      - "alerts.eco.tsi-dev.otc-service.com"
    servers:
      - name: "web3"
        address: "192.168.2.52:8080"
        opts: "cookie web3"
      - name: "alerta.infra.eco.tsi-dev.otc-service.com"
        address: "alerta.infra.eco.tsi-dev.otc-service.com:443"
        opts: "ssl verify none cookie infra sni req.hdr(Host)"
      - name: "alerta.apps.osinfra-mirror.eco.tsi-dev.otc-service.com"
        address: "alerta.apps.osinfra-mirror.eco.tsi-dev.otc-service.com:443"
        opts: "ssl verify none cookie osinfra-mirror sni req.hdr(Host)"

  - name: "influx"
    options:
      - "http-send-name-header Host"
    domain_names:
      - "influx1.eco.tsi-dev.otc-service.com"
    servers:
      - name: "influx1"
        address: "192.168.110.227:8086"
        opts: "check"

proxy_frontends:
  - name: "influx"
    bind: "*:8086 ssl crt /etc/ssl/{{ inventory_hostname }}/haproxy"
    backend: "influx"

statsd_host: "192.168.14.159"
statsd_port: "8125"

haproxy_expose_ports: ['80', '443', '8086']
