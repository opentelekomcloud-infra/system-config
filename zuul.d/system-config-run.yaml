- job:
    name: system-config-run
    description: |
      Run the "base" playbook for system-config hosts.

      This is a parent job designed to be inherited.
    abstract: true
    pre-run: playbooks/zuul/run-base-pre.yaml
    run: playbooks/zuul/run-base.yaml
    post-run: playbooks/zuul/run-base-post.yaml
    vars:
      install_ansible_ara_enable: false
      zuul_copy_output: "{{ copy_output | combine(host_copy_output | default({})) }}"
      stage_dir: "{{ ansible_user_dir }}/zuul-output"
      copy_output:
        '/var/log/syslog': logs_txt
        '/var/log/messages': logs_txt
        '/var/log/docker': logs
        '/var/log/containers': logs
    required-projects:
      - name: github.com/opentelekomcloud/ansible-collection-cloud
        override-checkout: master
      - name: github.com/stackmon/ansible-collection-apimon
        override-checkout: main
      - name: github.com/opentelekomcloud/ansible-collection-gitcontrol
        override-checkout: main
      - name: opendev.org/openstack/ansible-collections-openstack
        override-checkout: master
    host-vars:
      bridge.eco.tsi-dev.otc-service.com:
        host_copy_output:
          '{{ zuul.project.src_dir }}/junit.xml': logs
          '{{ zuul.project.src_dir }}/test-results.html': logs
          '{{ zuul.project.src_dir }}/inventory/base/gate-hosts.yaml': logs
          '/var/log/screenshots': logs

- job:
    name: system-config-run-base
    parent: system-config-run
    description: |
      Run the "base" playbook on each of the node types
      currently in use.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-jammy
    files:
      - tox.ini
      - playbooks/
      - roles/
      - testinfra/

- job:
    name: system-config-run-statsd
    parent: system-config-run
    description: |
      Run the "statsd" playbook on each of the node types
      currently in use.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-jammy
        - name: statsd.centos-stream
          label: centos-9-stream
    vars:
      run_playbooks:
        - playbooks/service-statsd.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/roles/statsd
      - testinfra/test_statsd.py

- job:
    name: system-config-run-x509-cert
    parent: system-config-run
    description: |
      Run the playbook for the x509 certificates.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
    vars:
      run_playbooks:
        - playbooks/x509-certs.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/x509-certs.yaml
      - playbooks/roles/x509_cert

- job:
    name: system-config-run-apimon-epmon
    parent: system-config-run
    description: |
      Run the "apimon-epmon" playbook on each of the node types
      currently in use.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: epmon.centos-stream
          label: centos-9-stream
        - name: epmon.focal
          label: ubuntu-focal
    vars:
      run_playbooks:
        - playbooks/service-apimon-epmon.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/templates/apimon
      - playbooks/zuul/templates/group_vars/apimon
      - playbooks/zuul/templates/host_vars/epmon
      - playbooks/service-apimon-epmon.yaml
      - testinfra/test_epmon.py

- job:
    name: system-config-run-apimon-scheduler
    parent: system-config-run
    description: |
      Run the "apimon-scheduler" playbook on each of the node types
      currently in use.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: scheduler.centos-stream
          label: centos-9-stream
        - name: scheduler.focal
          label: ubuntu-focal
    vars:
      run_playbooks:
        - playbooks/service-apimon-scheduler.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/templates/apimon
      - playbooks/zuul/templates/group_vars/apimon
      - playbooks/service-apimon-scheduler.yaml
      - testinfra/test_scheduler.py

- job:
    name: system-config-run-apimon-executor
    parent: system-config-run
    description: |
      Run the "apimon-executor" playbook on each of the node types
      currently in use.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: executor.centos-stream
          label: centos-9-stream
        - name: executor.focal
          label: ubuntu-focal
    vars:
      run_playbooks:
        - playbooks/service-apimon-executor.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/templates/apimon
      - playbooks/zuul/templates/group_vars/apimon
      - playbooks/service-apimon-executor.yaml
      - testinfra/test_executor.py

- job:
    name: system-config-run-graphite
    parent: system-config-run
    description: |
      Run the playbook for the graphite servers.
    timeout: 3600
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: graphite2.apimon.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: graphite1.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
    vars:
      run_playbooks:
        - playbooks/acme-certs.yaml
        - playbooks/service-graphite.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/service-graphite.yaml
      - playbooks/roles/graphite
      - playbooks/roles/graphite_web
      - playbooks/zuul/templates/group_vars/graphite.yaml.j2
      - testinfra/test_graphite.py

- job:
    name: system-config-run-memcached
    parent: system-config-run
    description: |
      Run the playbook for the memcached servers.
    timeout: 3600
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: memcached.focal
          label: ubuntu-focal
    vars:
      run_playbooks:
        - playbooks/service-memcached.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/service-memcached.yaml
      - playbooks/roles/memcached
      - testinfra/test_memcached.py

- job:
    name: system-config-run-alerta
    parent: system-config-run
    description: |
      Run the playbook for the alerta servers.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: alerta.focal
          label: ubuntu-focal
    vars:
      run_playbooks:
        - playbooks/service-alerta.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/service-alerta.yaml
      - playbooks/roles/alerta/
      - testinfra/test_alerta.py

- job:
    name: system-config-run-grafana
    parent: system-config-run
    description: |
      Run the playbook for the grafana servers.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: grafana.focal
          label: ubuntu-focal
    vars:
      run_playbooks:
        - playbooks/service-grafana.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/service-grafana.yaml
      - playbooks/roles/grafana/
      - testinfra/test_grafana.py

- job:
    name: system-config-run-acme-ssl
    parent: system-config-run
    description: |
      Run the playbook for the acme-ssl servers.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: le1
          label: ubuntu-focal
    vars:
      run_playbooks:
        - playbooks/acme-certs.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/acme-ssl.yaml
      - playbooks/roles/acme_create_certs
      - playbooks/roles/acme_request_certs
      - playbooks/roles/acme_install_txt_records
      - playbooks/roles/acme_drop_txt_records

- job:
    name: system-config-run-proxy
    parent: system-config-run
    description: |
      Run the playbook for the proxy servers.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: proxy1.eco.tsi-dev.otc-service.com
          label: centos-9-stream
    vars:
      run_playbooks:
        - playbooks/acme-certs.yaml
        - playbooks/service-proxy.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/service-proxy.yaml
      - playbooks/roles/haproxy
      - inventory/service/group_vars/proxy.yaml

- job:
    name: system-config-run-vault
    parent: system-config-run
    description: |
      Run the playbook for the vault servers.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: vault1.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
    vars:
      run_playbooks:
        # We do not want to create CA part of ZK setup, therefore only invoke additional playbook in the test.
        - playbooks/acme-certs.yaml
        - playbooks/service-vault.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/service-vault.yaml
      - playbooks/roles/hashivault
      - inventory/service/groups.yaml

- job:
    name: system-config-run-gitea
    parent: system-config-run
    description: |
      Run the playbook for the gitea servers.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-jammy
        - name: gitea.focal
          label: ubuntu-jammy
    vars:
      run_playbooks:
        - playbooks/service-gitea.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/service-gitea.yaml
      - playbooks/roles/gitea/
      - testinfra/test_gitea.py

- job:
    name: system-config-run-keycloak
    parent: system-config-run
    description: |
      Run the playbook for the keycloak servers.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-jammy
        - name: keycloak.focal
          label: ubuntu-jammy
    vars:
      run_playbooks:
        - playbooks/service-keycloak.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/service-keycloak.yaml
      - playbooks/roles/keycloak/
      - testinfra/test_keycloak.py

- job:
    name: system-config-run-zookeeper
    parent: system-config-run
    description: |
      Run the playbook for the zk servers.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: zk.centos-stream
          label: centos-9-stream
    vars:
      run_playbooks:
        # We do not want to create CA part of ZK setup, therefore only invoke additional playbook in the test.
        - playbooks/x509-certs.yaml
        - playbooks/service-zookeeper.yaml
    files:
      - playbooks/bootstrap-bridge.yaml
      - playbooks/service-zookeeper.yaml
      - playbooks/roles/zookeeper
      - inventory/service/groups.yaml
