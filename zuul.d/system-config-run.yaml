- job:
    name: system-config-run
    description: |
      Run the "base" playbook for system-config hosts.

      This is a parent job designed to be inherited.
    abstract: true
    pre-run: playbooks/zuul/run-base-pre.yaml
    run: playbooks/zuul/run-base.yaml
    post-run: playbooks/zuul/run-base-post.yaml
    vars:
      install_ansible_ara_enable: false
      zuul_copy_output: "{{ copy_output | combine(host_copy_output | default({})) }}"
      stage_dir: "{{ ansible_user_dir }}/zuul-output"
      copy_output:
        '/var/log/syslog': logs_txt
        '/var/log/messages': logs_txt
        '/var/log/docker': logs
        '/var/log/containers': logs
    required-projects:
      - name: github.com/opentelekomcloud/ansible-collection-apimon
        override-checkout: main
    host-vars:
      bridge.eco.tsi-dev.otc-service.com:
        host_copy_output:
          '{{ zuul.project.src_dir }}/junit.xml': logs
          '{{ zuul.project.src_dir }}/test-results.html': logs
          '{{ zuul.project.src_dir }}/inventory/base/gate-hosts.yaml': logs
          '/var/log/screenshots': logs

- job:
    name: system-config-run-base
    parent: system-config-run
    description: |
      Run the "base" playbook on each of the node types
      currently in use.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: f32
          label: fedora-32
    files:
      - tox.ini
      - playbooks/
      - roles/
      - testinfra/

- job:
    name: system-config-run-statsd
    parent: system-config-run
    description: |
      Run the "statsd" playbook on each of the node types
      currently in use.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: statsd.f31
          label: fedora-31
        - name: statsd.f32
          label: fedora-32
    vars:
      run_playbooks:
        - playbooks/service-statsd.yaml
    files:
      - tox.ini
      - playbooks/roles/statsd
      - testinfra/test_statsd.py

- job:
    name: system-config-run-apimon-epmon
    parent: system-config-run
    description: |
      Run the "apimon-epmon" playbook on each of the node types
      currently in use.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: epmon.f32
          label: fedora-32
        - name: epmon.focal
          label: ubuntu-focal
    vars:
      run_playbooks:
        - playbooks/service-apimon-epmon.yaml
    files:
      - tox.ini
      - playbooks/templates/apimon
      - playbooks/zuul/templates/group_vars/apimon
      - playbooks/zuul/templates/host_vars/epmon
      - playbooks/service-apimon-epmon.yaml
      - testinfra/test_epmon.py

- job:
    name: system-config-run-apimon-scheduler
    parent: system-config-run
    description: |
      Run the "apimon-scheduler" playbook on each of the node types
      currently in use.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: scheduler.f32
          label: fedora-32
        - name: scheduler.focal
          label: ubuntu-focal
    vars:
      run_playbooks:
        - playbooks/service-apimon-scheduler.yaml
    files:
      - tox.ini
      - playbooks/templates/apimon
      - playbooks/zuul/templates/group_vars/apimon
      - playbooks/service-apimon-scheduler.yaml
      - testinfra/test_scheduler.py

- job:
    name: system-config-run-apimon-executor
    parent: system-config-run
    description: |
      Run the "apimon-executor" playbook on each of the node types
      currently in use.
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: executor.f32
          label: fedora-32
        - name: executor.focal
          label: ubuntu-focal
    vars:
      run_playbooks:
        - playbooks/service-apimon-executor.yaml
    files:
      - tox.ini
      - playbooks/templates/apimon
      - playbooks/zuul/templates/group_vars/apimon
      - playbooks/service-apimon-executor.yaml
      - testinfra/test_executor.py

- job:
    name: system-config-run-graphite
    parent: system-config-run
    description: |
      Run the playbook for the graphite servers.
    timeout: 3600
    nodeset:
      nodes:
        - name: bridge.eco.tsi-dev.otc-service.com
          label: ubuntu-focal
        - name: graphite1.focal
          label: ubuntu-focal
        - name: graphite2.centos
          label: centos-8
    vars:
      run_playbooks:
        - playbooks/service-graphite.yaml
    host-vars:
      graphite1.focal:
        graphite_os_user: root
        graphite_os_group: root
      graphite2.centos:
        graphite_os_user: graphite
        graphite_os_group: graphite
    files:
      - tox.ini
      - playbooks/service-graphite.yaml
      - playbooks/roles/graphite
      - playbooks/zuul/templates/group_vars/graphite.yaml.j2
      - testinfra/test_graphite.py
