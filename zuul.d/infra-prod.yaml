# Make sure only one run of a system-config playbook happens at a time
- semaphore:
    name: infra-prod-playbook
    max: 1

- job:
    name: infra-prod-playbook
    parent: otc-infra-prod-base
    description: |
      Run specified playbook against productions hosts.

      This is a parent job designed to be inherited to enabled
      CD deployment of our infrastructure. Set playbook_name to
      specify the playbook relative to
      /home/zuul/src/github.com/opentelekomcloud-infra/system-config/playbooks
      on bridge.eco.tsi-dev.otc-service.com.
    abstract: true
    semaphore: infra-prod-playbook
    run: playbooks/zuul/run-production-playbook.yaml
    required-projects:
      - opentelekomcloud-infra/system-config
    vars:
      infra_prod_ansible_forks: 5
      infra_prod_playbook_collect_log: false
    nodeset:
      nodes: []

- job:
    name: infra-prod-install-ansible
    parent: infra-prod-playbook
    description: Install ansible on bridge.
    vars:
      playbook_name: install-ansible.yaml
    required-projects:
      - name: github.com/opentelekomcloud/ansible-collection-apimon
        override-checkout: main
      - name: github.com/opentelekomcloud/ansible-collection-cloud
        override-checkout: master
      - name: opendev.org/openstack/ansible-collections-openstack
        override-checkout: master
    files:
      - inventory/
      - roles/
      - install_modules.sh
      - modules.env
      - playbooks/install-ansible.yaml
      - playbooks/roles/pip3/
      - playbooks/roles/install-ansible/
      - playbooks/roles/logrotate/
      - playbooks/roles/root-keys/
      - inventory/service/host_vars/bridge.eco.tsi-dev.otc-service.com.yaml
      - playbooks/zuul/run-production-playbook.yaml

- job:
    name: infra-prod-base
    parent: infra-prod-playbook
    description: Run the base playbook everywhere.
    dependencies:
      - name: infra-prod-install-ansible
        soft: true
    vars:
      playbook_name: base.yaml
      infra_prod_ansible_forks: 50
    files:
      - inventory/
      - inventory/service/host_vars/
      - inventory/service/group_vars/
      - playbooks/base.yaml
      - playbooks/roles/base/

- job:
    name: infra-prod-service-base
    parent: infra-prod-playbook
    description: Base job for most service playbooks.
    abstract: true
    dependencies:
      - name: infra-prod-install-ansible
        soft: true

- job:
    name: infra-prod-service-bridge
    parent: infra-prod-service-base
    description: Run service-bridge.yaml playbook.
    vars:
      playbook_name: service-bridge.yaml
    files:
      - inventory/
      - playbooks/service-bridge.yaml
      - inventory/service/host_vars/bridge.eco-tsi-dev.otc-service.com.yaml
      - playbooks/roles/logrotate/
      - playbooks/roles/edit-secrets-script/
      - playbooks/roles/install-kubectl/
      - playbooks/roles/firewalld/
      - playbooks/roles/configure-kubectl/
      - playbooks/roles/configure-openstacksdk/
      - playbooks/templates/clouds/

- job:
    name: infra-prod-manage-github
    parent: infra-prod-service-base
    description: Run manage-github.yaml playbook.
    vars:
      playbook_name: manage-github.yaml
    allowed-projects:
      - github.com/opentelekomcloud-infra/gitstyring
      - github.com/opentelekomcloud-infra/system-config
    required-projects:
      - github.com/opentelekomcloud-infra/gitstyring
      - github.com/opentelekomcloud-infra/system-config

- job:
    name: infra-prod-service-statsd
    parent: infra-prod-service-base
    description: Run service-statsd.yaml playbook.
    vars:
      playbook_name: service-statsd.yaml
    files:
      - inventory/
      - playbooks/service-statsd.yaml
      - inventory/service/group_vars/statsd.yaml
      - playbooks/roles/statsd/

- job:
    name: infra-prod-service-x509-cert
    parent: infra-prod-service-base
    description: Run x509-certs.yaml playbook.
    vars:
      playbook_name: x509-certs.yaml
    files:
      - inventory/
      - playbooks/x509-certs.yaml
      - playbooks/roles/x509_cert

- job:
    name: infra-prod-service-apimon-epmon
    parent: infra-prod-service-base
    description: Run service-apimon-epmon.yaml playbook.
    vars:
      playbook_name: service-apimon-epmon.yaml
    files:
      - inventory/
      - playbooks/service-apimon-epmon.yaml

- job:
    name: infra-prod-service-apimon-scheduler
    parent: infra-prod-service-base
    description: Run service-apimon-scheduler.yaml playbook.
    vars:
      playbook_name: service-apimon-scheduler.yaml
    files:
      - inventory/
      - playbooks/service-apimon-scheduler.yaml

- job:
    name: infra-prod-service-apimon-executor
    parent: infra-prod-service-base
    description: Run service-apimon-executor.yaml playbook.
    vars:
      playbook_name: service-apimon-executor.yaml
    files:
      - inventory/
      - playbooks/service-apimon-executor.yaml

- job:
    name: infra-prod-service-apimon-k8s
    parent: infra-prod-service-base
    description: Run service-apimon-k8s.yaml playbook.
    vars:
      playbook_name: service-apimon-k8s.yaml
    files:
      - inventory/
      - playbooks/service-apimon-k8s.yaml
      - playbooks/roles/apimon_k8s

- job:
    name: infra-prod-service-graphite
    parent: infra-prod-service-base
    description: Run service-graphite.yaml playbook.
    vars:
      playbook_name: service-graphite.yaml
    files:
      - inventory/
      - playbooks/service-graphite.yaml
      - playbooks/roles/graphite/

- job:
    name: infra-prod-service-memcached
    parent: infra-prod-service-base
    description: Run service-memcached.yaml playbook.
    vars:
      playbook_name: service-memcached.yaml
    files:
      - inventory/
      - playbooks/service-memcached.yaml
      - playbooks/roles/memcached/

- job:
    name: infra-prod-service-alerta
    parent: infra-prod-service-base
    description: Run service-alerta.yaml playbook.
    vars:
      playbook_name: service-alerta.yaml
    files:
      - inventory/
      - playbooks/service-alerta.yaml
      - playbooks/roles/alerta/

- job:
    name: infra-prod-service-alerta-k8s
    parent: infra-prod-service-base
    description: Run service-alerta-k8s.yaml playbook.
    vars:
      playbook_name: service-alerta-k8s.yaml
    files:
      - inventory/
      - playbooks/service-alerta-k8s.yaml
      - playbooks/roles/alerta_k8s

- job:
    name: infra-prod-service-grafana-dashboards
    parent: infra-prod-service-base
    description: Run dashboards.yaml playbook.
    vars:
      playbook_name: dashboards.yaml
    files:
      - playbooks/dashboards.yaml
      - playbooks/templates/grafana

- job:
    name: infra-prod-service-grafana
    parent: infra-prod-service-base
    description: Run service-grafana.yaml playbook.
    vars:
      playbook_name: service-grafana.yaml
    files:
      - inventory/
      - playbooks/service-grafana.yaml
      - playbooks/roles/grafana/

- job:
    name: infra-prod-service-acme-ssl
    parent: infra-prod-service-base
    description: Run acme-certs.yaml playbook.
    vars:
      playbook_name: acme-certs.yaml
    files:
      - inventory/
      - playbooks/acme-certs.yaml
      - playbooks/roles/acme

- job:
    name: infra-prod-service-proxy
    parent: infra-prod-service-base
    description: Run service-proxy.yaml playbook.
    vars:
      playbook_name: service-proxy.yaml
    files:
      - inventory/
      - playbooks/service-proxy.yaml
      - playbooks/roles/haproxy/

- job:
    name: infra-prod-dashboards
    parent: infra-prod-service-base
    description: Run dashboards.yaml playbook.
    vars:
      playbook_name: dashboards.yaml
    files:
      - inventory/
      - playbooks/dashboards.yaml
      - playbooks/templates/grafana

- job:
    name: infra-prod-service-zuul
    parent: infra-prod-service-base
    description: Run service-zuul-k8s.yaml playbook.
    vars:
      playbook_name: service-zuul-k8s.yaml
    files:
      - inventory/group_vars/zuul.yaml
      - playbooks/service-zuul-k8s.yaml
      - playbooks/roles/zuul_k8s

- job:
    name: infra-prod-service-docs
    parent: infra-prod-service-base
    description: Run infra-prod-service-docs.yaml playbook.
    vars:
      playbook_name: service-docs.yaml
    files:
      - inventory/
      - playbooks/service-docs.yaml
      - playbooks/roles/document_hosting_k8s

- job:
    name: infra-prod-service-zookeeper
    parent: infra-prod-service-base
    description: Run service-zookeeper.yaml playbook.
    vars:
      playbook_name: service-zookeeper.yaml
    files:
      - inventory/
      - playbooks/service-zookeeper.yaml
      - playbooks/roles/zookeeper

- job:
    name: infra-prod-install-helm-chart
    parent: infra-prod-service-base
    description: Install HELM instances on k8s clusters
    vars:
      playbook_name: install-helm-chart.yaml
    files:
      - inventory/
      - playbooks/install-helm-chart.yaml
      - playbooks/roles/install-helm-chart

- job:
    name: infra-prod-install-cce
    parent: infra-prod-service-base
    description: Install cloud CCE clusters
    vars:
      playbook_name: cloud-cce.yaml
    files:
      - inventory/service/group_vars/cloud-launcher.yaml
      - playbooks/cloud-cce.yaml
      - playbooks/roles/cloud_cce
